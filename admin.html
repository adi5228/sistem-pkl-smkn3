<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Admin Panel - SMKN 3 Kendari</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  
  <style>
    body { 
        background-color: #f4f6f9; 
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        font-size: 0.9rem; 
        padding-bottom: 80px; 
    }
    
    /* Desktop Sidebar */
    .sidebar { 
        min-height: 100vh; 
        background: #2c3e50; 
        color: white; 
        box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
    }
    .sidebar h5 { letter-spacing: 1px; color: #ecf0f1; }
    .nav-link { 
        color: rgba(255,255,255,.7); 
        cursor: pointer; 
        padding: 12px 20px; 
        transition: all 0.3s; 
        border-radius: 0 25px 25px 0; 
        margin-bottom: 5px; 
    }
    .nav-link:hover, .nav-link.active { 
        color: white; 
        background: rgba(255,255,255,0.15); 
        padding-left: 25px; 
        border-left: 4px solid #3498db; 
    }
    
    /* Cards */
    .welcome-card { 
        background: linear-gradient(135deg, #3498db, #2980b9); 
        color: white; border: none; border-radius: 15px; 
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); 
        margin-bottom: 20px; 
    }
    .header-logo { 
        height: 65px; width: auto; 
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); 
        background: rgba(255,255,255,0.1); 
        padding: 5px; border-radius: 50%; 
        transition: transform 0.3s; 
    }
    .header-logo:hover { transform: scale(1.1); }
    
    .stat-card { 
        border: none; border-radius: 12px; 
        background: white; 
        box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
        transition: transform 0.2s; height: 100%; 
    }
    .chart-container { 
        background: white; border-radius: 15px; 
        padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 100%; 
    }
    
    .table-responsive { background: white; border-radius: 10px; overflow-x: auto; }
    .foto-cell img { 
        width: 40px; height: 53px; object-fit: cover; 
        border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; 
    }
    
    /* Crop Container */
    .img-container {
        max-height: 400px;
        background-color: #f7f7f7;
        margin-bottom: 10px;
        border: 1px dashed #ccc;
        border-radius: 8px;
        overflow: hidden;
        display: none; 
    }
    .img-container img { max-width: 100%; display: block; }

    /* Mobile Bottom Nav */
    .bottom-nav-btn {
        color: #6c757d;
        text-decoration: none;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 5px;
        font-size: 0.75rem;
        transition: color 0.2s;
    }
    .bottom-nav-btn.active { color: #3498db; font-weight: bold; }
    .bottom-nav-btn i { font-size: 1.4rem; margin-bottom: 2px; }

    /* Responsive Tweaks */
    @media (max-width: 768px) { 
        .header-logo { height: 45px; } 
        h2 { font-size: 1.3rem; } 
        .welcome-card { padding: 10px; }
        .sidebar { display: none !important; } 
        .col-md-10 { padding: 15px !important; }
        .stat-card h3 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>

<div class="container-fluid p-0">
  <div class="row g-0">
    
    <div class="col-md-2 sidebar p-3 d-none d-md-block">
      <h5 class="mb-4 text-center fw-bold py-3 border-bottom border-secondary">ADMIN PKL</h5>
      <div id="adminBadge" class="text-center mb-3 badge bg-secondary w-100 p-2" style="display:none;">Loading...</div>
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" onclick="switchTab('dashboard')"><i class="bi bi-grid-1x2-fill me-2"></i> Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" onclick="switchTab('data')"><i class="bi bi-people-fill me-2"></i> Data Siswa</a></li>
        <li class="nav-item" id="menuUsers"><a class="nav-link" onclick="switchTab('users')"><i class="bi bi-person-badge-fill me-2"></i> User Admin</a></li>
        <li class="nav-item mt-3 border-top border-secondary pt-3"><a class="nav-link" onclick="openAdminProfile()"><i class="bi bi-gear-fill me-2"></i> Pengaturan</a></li>
        <li class="nav-item"><a class="nav-link text-danger fw-bold" onclick="logout()"><i class="bi bi-box-arrow-left me-2"></i> Logout</a></li>
      </ul>
    </div>

    <div class="col-md-10 p-3 p-md-4">
      
      <div id="tab-dashboard">
        <div class="card welcome-card">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex align-items-center justify-content-between gap-2">
                    <img src="https://drive.google.com/thumbnail?id=1WB04Opaj-mN0nD0vLheD0FL2VuQ3OD5q&sz=w200" class="header-logo" alt="Sultra">
                    <div class="text-center flex-grow-1">
                        <h2 class="fw-bold mb-0">Dashboard</h2>
                        <p class="mb-2 opacity-75 small text-uppercase letter-spacing-1 d-none d-sm-block">Sistem Informasi PKL SMKN 3 Kendari</p>
                        <p class="mb-2 opacity-75 small text-uppercase letter-spacing-1 d-block d-sm-none" style="font-size:0.7rem">SMKN 3 Kendari</p>
                        <div class="bg-white text-primary d-inline-block px-4 py-1 rounded-pill shadow-sm mt-1">
                            <span class="fw-bold h4 m-0 me-2" id="totalSiswaBig">0</span>
                            <small class="fw-bold text-uppercase" style="font-size: 0.7rem;">Siswa</small>
                        </div>
                    </div>
                    <img src="https://drive.google.com/thumbnail?id=1k4CSzwMHage8h4jJSXpZFkyA1TiogD3j&sz=w200" class="header-logo" alt="SMKN 3">
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-secondary fw-bold m-0"><i class="bi bi-bar-chart-line-fill me-2"></i>Grafik Data</h5>
            <div class="d-flex align-items-center bg-white px-3 py-2 rounded shadow-sm">
                <label class="fw-bold me-2 small text-muted d-none d-sm-block">Filter Tahun:</label>
                <select id="dashboardYear" class="form-select form-select-sm border-primary fw-bold" style="width: auto;" onchange="loadStats()">
                    <option value="">Semua</option>
                </select>
            </div>
        </div>

        <div class="row mb-4 g-3">
            <div class="col-md-8">
                <div class="chart-container">
                    <h6 class="text-secondary fw-bold mb-3">SISWA PER JURUSAN</h6>
                    <canvas id="barChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container">
                    <h6 class="text-secondary fw-bold mb-3">KOMPOSISI</h6>
                    <canvas id="pieChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>

        <h5 class="text-secondary fw-bold mb-3">Rincian Data</h5>
        <div class="row g-2" id="statsContainer">
           <div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div><p>Memuat data...</p></div>
        </div>
      </div>

      <div id="tab-data" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h3 class="fw-bold text-secondary m-0">Data Siswa</h3>
          
          <div class="row g-2 align-items-center w-100 w-md-auto">
             <div class="col-6 col-md-auto">
                 <select id="selectJurusan" class="form-select form-select-sm shadow-sm" onchange="loadYearsAndData()">
                   <option value="tjkt">TJKT</option><option value="perhotelan">Perhotelan</option><option value="tata_boga">Tata Boga</option><option value="tata_busana">Tata Busana</option><option value="tata_kecantikan">Tata Kecantikan</option>
                 </select>
             </div>
             <div class="col-6 col-md-auto">
                 <select id="selectTahun" class="form-select form-select-sm shadow-sm" onchange="loadDataJurusan()"><option value="">Semua Thn</option></select>
             </div>
             <div class="col-12 col-md-auto">
                 <div class="input-group input-group-sm shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="searchSiswa" class="form-control border-start-0" placeholder="Cari Siswa..." onkeyup="filterTable('searchSiswa', 'tableBody')">
                 </div>
             </div>
             <div class="col-12 col-md-auto d-grid">
                 <button class="btn btn-primary btn-sm shadow-sm" onclick="handleExportSheet()"><i class="bi bi-file-earmark-excel"></i> Export Excel</button>
             </div>
          </div>
        </div>
        
        <div class="card shadow-sm border-0">
          <div class="card-body p-0 table-responsive">
            <table class="table table-hover align-middle mb-0 table-sm table-striped">
              <thead class="bg-dark text-white text-nowrap">
                <tr><th class="ps-3 py-2">Foto</th><th>NISN</th><th>Nama</th><th>Tahun</th><th>HP Siswa</th><th>HP Ortu</th><th>Alamat</th><th class="text-center">Aksi</th></tr>
              </thead>
              <tbody id="tableBody"><tr><td colspan="8" class="text-center p-5 text-muted">Pilih jurusan...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="tab-users" style="display:none;">
        <h3 class="fw-bold mb-4 text-secondary">Manajemen User</h3>
        <div class="row">
          <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 1;">
              <div class="card-header bg-primary text-white fw-bold"><i class="bi bi-person-plus-fill me-2"></i> Tambah Akun</div>
              <div class="card-body p-4">
                <form onsubmit="handleCreateUser(event)">
                  <div class="mb-3"><label class="form-label fw-bold">NISN</label><input type="text" id="newNisn" class="form-control" required placeholder="Login User"></div>
                  <div class="mb-3"><label class="form-label fw-bold">Nama</label><input type="text" id="newNama" class="form-control" required placeholder="Nama Lengkap"></div>
                  
                  <div class="mb-3">
                      <label class="form-label fw-bold">Tahun PKL</label>
                      <input type="number" id="newTahun" class="form-control" required placeholder="Contoh: 2026" value="2026">
                  </div>

                  <div class="mb-3"><label class="form-label fw-bold">Password Default</label><input type="text" id="newPass" class="form-control" value="123456" required></div>
                  <div class="mb-3">
                    <label class="form-label fw-bold">Jurusan</label>
                    <select id="newJurusan" class="form-select">
                       <option value="tjkt">TJKT</option><option value="perhotelan">Perhotelan</option><option value="tata_boga">Tata Boga</option><option value="tata_busana">Tata Busana</option><option value="tata_kecantikan">Tata Kecantikan</option>
                    </select>
                  </div>
                  <div class="d-grid"><button type="submit" id="btnCreate" class="btn btn-primary fw-bold">Simpan</button></div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-8">
              <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                  <span>Daftar User Terdaftar</span>
                  <div class="d-flex gap-2">
                      <div class="input-group input-group-sm" style="max-width: 150px;">
                        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
                        <input type="text" id="searchUser" class="form-control" placeholder="Cari..." onkeyup="filterTable('searchUser', 'userTableBody')">
                      </div>
                      <button class="btn btn-sm btn-outline-secondary" onclick="loadUsersList()"><i class="bi bi-arrow-clockwise"></i></button>
                  </div>
                </div>
                <div class="card-body p-0 table-responsive user-table-container">
                  <table class="table table-striped table-hover mb-0 table-sm">
                    <thead class="bg-light sticky-top text-nowrap" style="top: 0; z-index: 2;">
                      <tr><th class="ps-3">NISN</th><th>Nama</th><th>Jurusan</th><th>Role</th><th class="text-center">Aksi</th></tr>
                    </thead>
                    <tbody id="userTableBody"><tr><td colspan="5" class="text-center p-4">Memuat data...</td></tr></tbody>
                  </table>
                </div>
              </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-md-none fixed-bottom bg-white border-top d-flex justify-content-around py-2 shadow-lg" style="z-index: 1050;">
    <a onclick="switchTab('dashboard')" class="bottom-nav-btn active" id="btn-nav-dashboard">
        <i class="bi bi-grid-1x2-fill"></i><span>Home</span>
    </a>
    <a onclick="switchTab('data')" class="bottom-nav-btn" id="btn-nav-data">
        <i class="bi bi-people-fill"></i><span>Siswa</span>
    </a>
    <a onclick="switchTab('users')" class="bottom-nav-btn" id="btn-nav-users">
        <i class="bi bi-person-badge-fill"></i><span>Users</span>
    </a>
    <a onclick="openAdminProfile()" class="bottom-nav-btn" id="btn-nav-setting">
        <i class="bi bi-gear-fill"></i><span>Akun</span>
    </a>
    <a onclick="logout()" class="bottom-nav-btn text-danger">
        <i class="bi bi-box-arrow-right"></i><span>Keluar</span>
    </a>
</div>

<div class="modal fade" id="editJurusanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Ganti Jurusan Siswa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form onsubmit="handleSubmitEditJurusan(event)">
            <input type="hidden" id="editOldJurusan">
            <div class="mb-3"><label class="form-label fw-bold">NISN</label><input type="text" id="editNisn" class="form-control bg-light" readonly></div>
            <div class="mb-3"><label class="form-label fw-bold">Nama Siswa</label><input type="text" id="editNama" class="form-control bg-light" readonly></div>
            <div class="mb-3">
                <label class="form-label fw-bold text-primary">Pindah ke Jurusan:</label>
                <select id="selectNewJurusan" class="form-select border-primary" required>
                    <option value="tjkt">TJKT</option><option value="perhotelan">Perhotelan</option><option value="tata_boga">Tata Boga</option><option value="tata_busana">Tata Busana</option><option value="tata_kecantikan">Tata Kecantikan</option>
                </select>
            </div>
            <div class="d-grid"><button type="submit" class="btn btn-info text-white fw-bold">SIMPAN PERUBAHAN</button></div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editSiswaModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"> 
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-person-lines-fill me-2"></i>Edit Siswa</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form onsubmit="handleSaveSiswa(event)">
            <input type="hidden" id="esJurusan">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold small">NISN</label>
                    <input type="text" id="esNisn" class="form-control bg-light" readonly>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold small">Nama Lengkap</label>
                    <input type="text" id="esNama" class="form-control" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold small">Tahun PKL</label>
                    <input type="number" id="esTahun" class="form-control" required placeholder="Contoh: 2026">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold small">HP Siswa</label>
                    <input type="text" id="esHpSiswa" class="form-control" placeholder="08...">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small">Alamat Lengkap</label>
                <textarea id="esAlamat" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold small">HP Orang Tua</label>
                <input type="text" id="esHpOrtu" class="form-control" placeholder="08...">
            </div>
            <div class="card bg-light border-0">
                <div class="card-body">
                    <label class="form-label fw-bold d-block small"><i class="bi bi-camera-fill me-2"></i>Sesuaikan Foto (3:4)</label>
                    <div class="row align-items-center">
                        <div class="col-4 text-center mb-2">
                            <img id="esFotoCurrent" src="" style="width: 80px; height: 106px; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); background: #eee;">
                        </div>
                        <div class="col-8">
                            <input type="file" id="esFotoUpload" class="form-control form-control-sm mb-2" accept="image/*" onchange="initCropper(this)">
                            <div class="img-container" style="height: 250px;">
                                <img id="imageToCrop" src="">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-grid mt-4">
                <button type="submit" id="btnSaveSiswa" class="btn btn-primary fw-bold py-2">SIMPAN</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="adminProfileModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>Profil Admin</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
         <div class="alert alert-warning small">
             <i class="bi bi-exclamation-triangle-fill me-1"></i>
             Jika Username/Password diubah, Anda harus login ulang.
         </div>
         <form onsubmit="handleUpdateAdmin(event)">
             <div class="mb-3">
                 <label class="form-label fw-bold">Username Login</label>
                 <input type="text" id="adminNewUsername" class="form-control" required>
             </div>
             <div class="mb-3">
                 <label class="form-label fw-bold">Password Baru</label>
                 <input type="password" id="adminNewPassword" class="form-control" placeholder="Kosongkan jika tidak ingin ganti">
             </div>
             <div class="d-grid">
                 <button type="submit" id="btnUpdateAdmin" class="btn btn-dark fw-bold">SIMPAN PERUBAHAN</button>
             </div>
         </form>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let barChartInstance = null;
  let pieChartInstance = null;
  let editJurusanModal;
  let editSiswaModal;
  let adminProfileModal; 
  let currentAdminJurusan = '-'; 
  let currentAdminNisn = ''; 
  let cropper;

  function initAdmin() {
      const token = localStorage.getItem('sessionToken');
      if(!token) return logout();

      google.script.run.withSuccessHandler(res => {
          if(!res.success) return logout();
          
          const userData = res.data.user;
          currentAdminJurusan = userData.jurusan || '-';
          currentAdminNisn = userData.nisn; 
          
          const badge = document.getElementById('adminBadge');
          badge.style.display = 'block';

          if(currentAdminJurusan === '-') {
              badge.innerText = "SUPER ADMIN";
              badge.className = "text-center mb-3 badge bg-danger w-100 p-2";
          } else {
              let niceName = currentAdminJurusan.toUpperCase().replace(/_/g, ' ');
              badge.innerText = "ADMIN " + niceName;
              badge.className = "text-center mb-3 badge bg-success w-100 p-2";
              
              const selectJur = document.getElementById('selectJurusan');
              const newJur = document.getElementById('newJurusan');
              selectJur.value = currentAdminJurusan;
              if(newJur) newJur.value = currentAdminJurusan;
              
              selectJur.disabled = true;
              if(newJur) newJur.disabled = true;
          }
          loadDashboardYears();
      }).api('getDashboardData', { sessionToken: token });
  }

  function switchTab(tabName) {
    ['dashboard', 'data', 'users'].forEach(t => document.getElementById('tab-' + t).style.display = 'none');
    
    if(document.getElementById('tab-' + tabName)) {
        document.getElementById('tab-' + tabName).style.display = 'block';
    }
    
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
    if(event && event.currentTarget.classList.contains('nav-link')) event.currentTarget.classList.add('active');
    
    document.querySelectorAll('.bottom-nav-btn').forEach(el => el.classList.remove('active'));
    const bottomBtn = document.getElementById('btn-nav-' + tabName);
    if(bottomBtn) bottomBtn.classList.add('active');

    if(tabName === 'dashboard') loadStats();
    if(tabName === 'data') {
        if (currentAdminJurusan !== '-') { loadYearsAndData(); } else {
            const val = document.getElementById('selectJurusan').value;
            if(val) loadYearsAndData();
        }
    }
    if(tabName === 'users') loadUsersList(); 
  }

  // --- LOGOUT AMAN (ANTI-SANDBOX) ---
  function logout() {
    Swal.fire({
      title: 'Keluar?',
      text: "Sesi Anda akan berakhir.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ya, Logout'
    }).then((result) => {
      if (result.isConfirmed) {
        localStorage.clear();
        
        // Ambil URL Aplikasi dan Redirect dengan metode window.open pada user gesture
        google.script.run.withSuccessHandler(url => {
            Swal.fire({
                title: 'Logout Berhasil',
                text: 'Klik OK untuk kembali ke login.',
                icon: 'success',
                confirmButtonText: 'OK',
                allowOutsideClick: false
            }).then(() => {
                window.open(url, '_top');
            });
        }).getAppUrl();
      }
    });
  }

  function openAdminProfile() {
      if(!adminProfileModal) adminProfileModal = new bootstrap.Modal(document.getElementById('adminProfileModal'));
      document.getElementById('adminNewUsername').value = currentAdminNisn;
      document.getElementById('adminNewPassword').value = '';
      adminProfileModal.show();
  }

  function handleUpdateAdmin(e) {
      e.preventDefault();
      const newU = document.getElementById('adminNewUsername').value;
      const newP = document.getElementById('adminNewPassword').value;
      const token = localStorage.getItem('sessionToken');
      const btn = document.getElementById('btnUpdateAdmin');
      btn.disabled = true; btn.innerText = 'Menyimpan...';

      google.script.run.withSuccessHandler(res => {
          btn.disabled = false; btn.innerText = 'SIMPAN PERUBAHAN';
          if(res.success) {
              adminProfileModal.hide();
              Swal.fire({title: 'Berhasil', text: 'Profil diperbarui. Silakan login ulang.', icon: 'success'}).then(() => logout());
          } else { Swal.fire('Gagal', res.error, 'error'); }
      }).api('adminUpdateCredentials', { sessionToken: token, newUsername: newU, newPassword: newP });
  }

  function loadYearsAndData() {
      const token = localStorage.getItem('sessionToken');
      let jurusan = document.getElementById('selectJurusan').value;
      if (currentAdminJurusan !== '-') jurusan = currentAdminJurusan;
      const selectTahun = document.getElementById('selectTahun');
      
      google.script.run.withSuccessHandler(res => {
          if (res.success) {
             let opts = '<option value="">Semua Tahun</option>';
             res.years.forEach(y => { opts += `<option value="${y}">${y}</option>`; });
             selectTahun.innerHTML = opts;
             loadDataJurusan();
          } else { loadDataJurusan(); }
      }).api('getAvailableYears', { jurusan: jurusan, sessionToken: token });
  }

  function loadDataJurusan() {
    const token = localStorage.getItem('sessionToken');
    let jurusan = document.getElementById('selectJurusan').value;
    if (currentAdminJurusan !== '-') {
        jurusan = currentAdminJurusan;
        document.getElementById('selectJurusan').value = jurusan;
    }
    const tahun = document.getElementById('selectTahun').value;
    const tbody = document.getElementById('tableBody');
    if (!jurusan || jurusan === "") { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-muted">Silakan pilih jurusan.</td></tr>'; return; }

    let displayJurusan = jurusan.toUpperCase().replace(/_/g, ' ');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5"><div class="spinner-border text-primary mb-2"></div><br>Mengambil data <b>' + displayJurusan + '</b>...</td></tr>';
    document.getElementById('searchSiswa').value = ''; 
    
    google.script.run.withSuccessHandler(res => {
      if(res.success) {
         if(res.students.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="text-center p-5 text-muted"><i class="bi bi-inbox fs-1 d-block mb-2"></i>Belum ada data siswa.</td></tr>'; return; }
         let rows = '';
         res.students.forEach(s => {
            let img = s.foto_url ? `<a href="${s.foto_url}" target="_blank"><img src="${s.foto_url}"></a>` : '<span class="badge bg-secondary">No Foto</span>';
            rows += `<tr><td class="foto-cell ps-3">${img}</td><td class="font-monospace fw-bold">${s.nisn}</td><td class="fw-bold text-secondary">${s.nama}</td><td><span class="badge bg-info text-dark">${s.tahun_pkl || '-'}</span></td><td>${s.hp_siswa}</td><td class="text-danger">${s.hp_ortu}</td><td class="small text-truncate" style="max-width:150px">${s.alamat}</td><td class="text-center"><div class="btn-group btn-group-sm"><button class="btn btn-primary" onclick="openEditSiswa('${s.nisn}', '${jurusan}')" title="Edit Lengkap"><i class="bi bi-pencil-fill"></i></button><button class="btn btn-outline-danger" onclick="confirmDelete('${s.nisn}', '${s.nama}', '${jurusan}')" title="Hapus"><i class="bi bi-trash"></i></button></div></td></tr>`;
         });
         tbody.innerHTML = rows;
      } else { tbody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-danger">Error: ${res.error}</td></tr>`; }
    }).api('getAdminData', { jurusan: jurusan, tahun: tahun, sessionToken: token });
  }

  function openEditSiswa(nisn, jurusan) {
      if(!editSiswaModal) editSiswaModal = new bootstrap.Modal(document.getElementById('editSiswaModal'));
      const token = localStorage.getItem('sessionToken');
      
      document.getElementById('esFotoUpload').value = "";
      document.getElementById('esFotoCurrent').src = "https://via.placeholder.com/120x160?text=No+Img"; 
      document.querySelector('.img-container').style.display = 'none'; 
      if(cropper) { cropper.destroy(); cropper = null; } 

      document.getElementById('btnSaveSiswa').disabled = true;
      document.getElementById('btnSaveSiswa').innerText = "Loading data...";

      google.script.run.withSuccessHandler(res => {
          document.getElementById('btnSaveSiswa').disabled = false;
          document.getElementById('btnSaveSiswa').innerText = "SIMPAN PERUBAHAN";
          if(res.success) {
              const d = res.data;
              document.getElementById('esJurusan').value = jurusan;
              document.getElementById('esNisn').value = d.nisn;
              document.getElementById('esNama').value = d.nama;
              document.getElementById('esTahun').value = d.tahun_pkl;
              document.getElementById('esHpSiswa').value = d.hp_siswa;
              document.getElementById('esHpOrtu').value = d.hp_ortu;
              document.getElementById('esAlamat').value = d.alamat;
              if(d.foto_id) { document.getElementById('esFotoCurrent').src = "https://drive.google.com/thumbnail?id=" + d.foto_id + "&sz=w200"; }
              editSiswaModal.show();
          } else { Swal.fire('Error', res.error, 'error'); }
      }).api('adminGetStudentDetail', { sessionToken: token, nisn: nisn, jurusan: jurusan });
  }

  function initCropper(input) {
      if (input.files && input.files[0]) {
          const file = input.files[0];
          if (!file.type.startsWith('image/')) { Swal.fire('Error', 'File harus gambar!', 'error'); input.value = ""; return; }
          const reader = new FileReader();
          reader.onload = function(e) {
              const image = document.getElementById('imageToCrop');
              image.src = e.target.result;
              document.querySelector('.img-container').style.display = 'block';
              if(cropper) cropper.destroy();
              cropper = new Cropper(image, { aspectRatio: 3 / 4, viewMode: 1, autoCropArea: 1, });
          };
          reader.readAsDataURL(file);
      }
  }

  function handleSaveSiswa(e) {
      e.preventDefault();
      const btn = document.getElementById('btnSaveSiswa');
      btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
      const token = localStorage.getItem('sessionToken');
      
      const payload = {
          nisn: document.getElementById('esNisn').value,
          jurusan: document.getElementById('esJurusan').value,
          nama: document.getElementById('esNama').value,
          tahun_pkl: document.getElementById('esTahun').value,
          hp_siswa: document.getElementById('esHpSiswa').value,
          hp_ortu: document.getElementById('esHpOrtu').value,
          alamat: document.getElementById('esAlamat').value,
          fotoData: null
      };

      const submitData = () => {
          google.script.run.withSuccessHandler(res => {
              btn.disabled = false; btn.innerText = "SIMPAN PERUBAHAN";
              if(res.success) {
                  editSiswaModal.hide();
                  Swal.fire('Sukses', 'Data & Foto berhasil disimpan', 'success');
                  loadDataJurusan(); 
              } else { Swal.fire('Gagal', res.error, 'error'); }
          }).api('adminSaveStudentDetail', { ...payload, sessionToken: token });
      };

      if (cropper) {
          const canvas = cropper.getCroppedCanvas({ width: 450, height: 600, imageSmoothingEnabled: true, imageSmoothingQuality: 'high', });
          const base64Data = canvas.toDataURL('image/jpeg', 0.8);
          payload.fotoData = { data: base64Data.split(',')[1], mime: 'image/jpeg' };
          submitData();
      } else { submitData(); }
  }

  function loadDashboardYears() {
      const token = localStorage.getItem('sessionToken');
      google.script.run.withSuccessHandler(years => {
          let opts = '<option value="">Semua Data</option>';
          if(years && years.length > 0) { years.forEach(y => opts += `<option value="${y}">${y}</option>`); }
          document.getElementById('dashboardYear').innerHTML = opts;
          loadStats();
      }).api('getDashboardYears', { sessionToken: token });
  }

  function loadStats() {
    const token = localStorage.getItem('sessionToken');
    const selectedYear = document.getElementById('dashboardYear').value;
    document.getElementById('totalSiswaBig').innerText = "...";
    google.script.run.withSuccessHandler(res => {
       if(res.success) {
         let html = '';
         const colors = ['#3498db', '#e74c3c', '#f1c40f', '#9b59b6', '#2ecc71'];
         const bgColors = ['rgba(52, 152, 219, 0.2)', 'rgba(231, 76, 60, 0.2)', 'rgba(241, 196, 15, 0.2)', 'rgba(155, 89, 182, 0.2)', 'rgba(46, 204, 113, 0.2)'];
         let labels = []; let dataValues = []; let i = 0;
         for (const [key, val] of Object.entries(res.stats)) {
            let label = key.toUpperCase().replace(/_/g, ' ');
            if(label === 'TKJ') label = 'TJKT';
            labels.push(label); dataValues.push(val);
            html += `<div class="col-md-2 col-6 mb-3"><div class="stat-card p-3 text-center"><h3 class="fw-bold m-0" style="color: ${colors[i % 5]}">${val}</h3><small class="text-muted fw-bold" style="font-size:0.75rem">${label}</small></div></div>`;
            i++;
         }
         document.getElementById('totalSiswaBig').innerText = res.total;
         document.getElementById('statsContainer').innerHTML = html;
         renderCharts(labels, dataValues, colors, bgColors);
       } else if(res.sessionExpired) logout();
    }).api('getAdminStats', { sessionToken: token, year: selectedYear });
  }

  function renderCharts(labels, data, colors, bgColors) {
      const ctxBar = document.getElementById('barChart').getContext('2d');
      if (barChartInstance) barChartInstance.destroy();
      barChartInstance = new Chart(ctxBar, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Jumlah Siswa', data: data, backgroundColor: colors, borderRadius: 5 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
      const ctxPie = document.getElementById('pieChart').getContext('2d');
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctxPie, { type: 'doughnut', data: { labels: labels, datasets: [{ data: data, backgroundColor: colors, hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } } });
  }

  function loadUsersList() {
    const token = localStorage.getItem('sessionToken');
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center p-3">Mengambil data...</td></tr>';
    document.getElementById('searchUser').value = '';
    google.script.run.withSuccessHandler(res => {
       if(res.success) {
          let rows = '';
          res.users.forEach(u => {
             let roleBadge = u.role === 'ADMIN' ? '<span class="badge bg-danger">ADMIN</span>' : '<span class="badge bg-success">SISWA</span>';
             let btnAksi = `
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-warning text-white" onclick="confirmResetPass('${u.nisn}', '${u.nama}')" title="Reset Password"><i class="bi bi-key-fill"></i></button>
                    <button class="btn btn-light text-danger" onclick="confirmDelete('${u.nisn}', '${u.nama}', '${u.jurusan}')" title="Hapus"><i class="bi bi-trash"></i></button>
                </div>`;
             if(currentAdminJurusan === '-') {
                 btnAksi = `<div class="btn-group btn-group-sm"><button class="btn btn-info text-white" onclick="openEditJurusan('${u.nisn}', '${u.nama}', '${u.jurusan}')" title="Ganti Jurusan"><i class="bi bi-pencil-square"></i></button>${btnAksi}</div>`;
             }
             if(u.role === 'ADMIN') btnAksi = '<span class="text-muted small">Protected</span>'; 
             
             let displayJurusan = u.jurusan.toUpperCase();
             if (displayJurusan === 'TKJ') displayJurusan = 'TJKT';
             rows += `<tr><td class="ps-3 font-monospace">${u.nisn}</td><td class="fw-bold">${u.nama}</td><td>${displayJurusan}</td><td>${roleBadge}</td><td class="text-center">${btnAksi}</td></tr>`;
          });
          tbody.innerHTML = rows;
       }
    }).api('getAdminUsers', { sessionToken: token });
  }

  function handleCreateUser(e) {
    e.preventDefault();
    const token = localStorage.getItem('sessionToken');
    const btn = document.getElementById('btnCreate');
    btn.disabled = true; btn.innerHTML = 'Wait...';
    
    let jurusan = document.getElementById('newJurusan').value;
    if (currentAdminJurusan !== '-') jurusan = currentAdminJurusan;
    
    const formData = { 
        nisn: document.getElementById('newNisn').value, 
        nama: document.getElementById('newNama').value, 
        password: document.getElementById('newPass').value, 
        jurusan: jurusan,
        tahun: document.getElementById('newTahun').value
    };
    
    google.script.run.withSuccessHandler(res => {
      btn.disabled = false; btn.innerHTML = 'Simpan';
      if(res.success) { Swal.fire('Sukses', 'User dibuat', 'success'); document.getElementById('newNisn').value = ''; document.getElementById('newNama').value = ''; loadStats(); loadUsersList(); }
      else Swal.fire('Gagal', res.error, 'error');
    }).api('adminCreateUser', { ...formData, sessionToken: token });
  }

  function confirmDelete(nisn, nama, jurusan) {
      Swal.fire({title: 'Hapus?', text: `Hapus data ${nama}?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33'}).then((result) => {
        if (result.isConfirmed) {
           const token = localStorage.getItem('sessionToken');
           google.script.run.withSuccessHandler(res => {
              if(res.success) { Swal.fire('Terhapus', res.message, 'success'); if(document.getElementById('tab-data').style.display === 'block') loadDataJurusan(); if(document.getElementById('tab-users').style.display === 'block') loadUsersList(); loadStats(); }
              else Swal.fire('Gagal', res.error, 'error');
           }).api('adminDeleteUser', { sessionToken: token, nisn: nisn, jurusan: jurusan });
        }
      });
  }

  function confirmResetPass(nisn, nama) {
      Swal.fire({title: 'Reset Password?', text: `Password untuk ${nama} akan kembali menjadi 123456.`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: 'Ya, Reset'}).then((result) => {
        if (result.isConfirmed) {
           const token = localStorage.getItem('sessionToken');
           google.script.run.withSuccessHandler(res => { if(res.success) Swal.fire('Berhasil', res.message, 'success'); else Swal.fire('Gagal', res.error, 'error'); }).api('adminResetPassword', { sessionToken: token, nisn: nisn });
        }
      });
  }

  function filterTable(inputId, tableBodyId) {
      const input = document.getElementById(inputId).value.toLowerCase();
      const tbody = document.getElementById(tableBodyId);
      const rows = tbody.getElementsByTagName('tr');
      let visibleCount = 0; let totalCols = 5;
      const oldNoData = document.getElementById('no-data-' + tableBodyId);
      if (oldNoData) oldNoData.remove();

      for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (row.cells.length < 2) continue; 
          totalCols = row.cells.length;
          const text = row.textContent.toLowerCase();
          if (text.includes(input)) { row.style.display = ''; visibleCount++; } 
          else { row.style.display = 'none'; }
      }
      if (visibleCount === 0 && input !== '') {
          const newRow = tbody.insertRow();
          newRow.id = 'no-data-' + tableBodyId;
          newRow.innerHTML = `<td colspan="${totalCols}" class="text-center text-muted py-4 fw-bold"><i class="bi bi-search me-2"></i> Data "${document.getElementById(inputId).value}" tidak ditemukan</td>`;
      }
  }

  function openEditJurusan(nisn, nama, currentJurusan) {
      if(!editJurusanModal) editJurusanModal = new bootstrap.Modal(document.getElementById('editJurusanModal'));
      document.getElementById('editNisn').value = nisn;
      document.getElementById('editNama').value = nama;
      document.getElementById('editOldJurusan').value = currentJurusan;
      document.getElementById('selectNewJurusan').value = currentJurusan;
      editJurusanModal.show();
  }

  function handleSubmitEditJurusan(e) {
      e.preventDefault();
      const nisn = document.getElementById('editNisn').value;
      const oldJurusan = document.getElementById('editOldJurusan').value;
      const newJurusan = document.getElementById('selectNewJurusan').value;
      if(oldJurusan === newJurusan) { Swal.fire('Info', 'Jurusan sama.', 'info'); return; }
      const token = localStorage.getItem('sessionToken');
      Swal.fire({title: 'Memindahkan...', text: 'Tunggu sebentar', didOpen: () => Swal.showLoading()});
      google.script.run.withSuccessHandler(res => {
          if(res.success) { editJurusanModal.hide(); Swal.fire('Berhasil', res.message, 'success'); loadUsersList(); loadStats(); }
          else Swal.fire('Gagal', res.error, 'error');
      }).api('adminChangeJurusan', { sessionToken: token, nisn: nisn, oldJurusan: oldJurusan, newJurusan: newJurusan });
  }

  function handleExportSheet() {
      const token = localStorage.getItem('sessionToken');
      let jurusan = document.getElementById('selectJurusan').value;
      if (currentAdminJurusan !== '-') jurusan = currentAdminJurusan;
      const tahun = document.getElementById('selectTahun').value; 
      Swal.fire({title: 'Creating Sheet...', text: 'Tunggu sebentar...', didOpen: () => Swal.showLoading()});
      google.script.run.withSuccessHandler(res => {
          Swal.close();
          if(res.success) Swal.fire({title: 'Berhasil', html: `<a href="${res.url}" target="_blank" class="btn btn-primary">Buka File</a>`, icon: 'success', showConfirmButton: false});
          else Swal.fire('Gagal', res.error, 'error');
      }).api('adminExportSheet', { sessionToken: token, jurusan: jurusan, tahun: tahun });
  }

  window.onload = function() { initAdmin(); };
</script>
</body>
</html>